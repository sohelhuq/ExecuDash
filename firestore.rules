/**
 * @fileOverview Firestore Security Rules for Firestudio.
 *
 * @corePhilosophy This ruleset enforces a strict project-based access control model.
 *   All access is governed by project membership. All write operations are restricted
 *   to authenticated users only. Read access to the entire database is forbidden.
 *   These rules assume that project membership is handled via an external authentication
 *   mechanism that is not directly represented within the data model itself. This means
 *   that the rules cannot directly verify a user's role or permissions; they only ensure
 *   that the user is authenticated.
 *
 * @dataStructure The data is structured hierarchically under /projects/{projectId}, with
 *   subcollections for modules, Telegram bots, and finance data syncs. Each subcollection
 *   includes a denormalized 'projectId' field to enable independent authorization checks.
 *
 * @keySecurityDecisions
 *   - No user listing: Listing users or projects is disallowed to prevent information disclosure.
 *   - Default deny: Any access not explicitly allowed is denied, ensuring a secure default posture.
 *   - No data validation: In the interests of rapid prototyping, data validation is not performed.
 *
 * @denormalizationForAuthorization The `projectId` field is denormalized into the Module,
 *   TelegramBot, and FinanceDataSync documents to avoid costly `get()` calls and enable
 *   efficient authorization checks within subcollections.
 *
 * @structuralSegregation All data within a project's subcollections shares the same
 *   access control policies, simplifying rule management and ensuring consistent security.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the user is signed in.
     * @param {string} userId The user's ID.
     * @returns {boolean} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the document.
     * @param {string} userId The user's ID.
     * @returns {boolean} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
        return request.auth.uid == userId;
    }

    /**
     * @description Checks if the user is the owner of the document and the document exists.
     * @param {string} userId The user's ID.
     * @returns {boolean} True if the user is the owner and the document exists, false otherwise.
     */
    function isExistingOwner(userId) {
      return isOwner(userId) && resource != null;
    }

    /**
     * @description Rule for the /projects collection.
     * @path /projects/{projectId}
     * @allow (create) Signed-in user can create a project.
     * @deny (create) Non-signed-in user cannot create a project.
     * @deny (update) Any user cannot update project.
     * @deny (delete) Any user cannot delete project.
     * @principle Enforces signed-in user for create operations on the /projects collection.
     */
    match /projects/{projectId} {
      allow get: if false;
      allow list: if false;
      allow create: if isSignedIn();
      allow update: if false;
      allow delete: if false;

      /**
       * @description Rule for the /projects/{projectId}/modules collection.
       * @path /projects/{projectId}/modules/{moduleId}
       * @allow (create) Signed-in user can create a module within a project.
       * @deny (create) Non-signed-in user cannot create a module.
       * @allow (list) Signed-in user can list modules within a project.
       * @deny (update) Any user cannot update a module.
       * @deny (delete) Any user cannot delete a module.
       * @principle Enforces signed-in user for create and list operations on the /projects/{projectId}/modules collection.
       */
      match /modules/{moduleId} {
        allow get: if false;
        allow list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Rule for the /projects/{projectId}/telegram_bots collection.
       * @path /projects/{projectId}/telegram_bots/{telegramBotId}
       * @allow (create) Signed-in user can create a Telegram bot within a project.
       * @deny (create) Non-signed-in user cannot create a Telegram bot.
       * @allow (list) Signed-in user can list Telegram bots within a project.
       * @deny (update) Any user cannot update a Telegram bot.
       * @deny (delete) Any user cannot delete a Telegram bot.
       * @principle Enforces signed-in user for create and list operations on the /projects/{projectId}/telegram_bots collection.
       */
      match /telegram_bots/{telegramBotId} {
        allow get: if false;
        allow list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if false;
      }

      /**
       * @description Rule for the /projects/{projectId}/finance_data_syncs collection.
       * @path /projects/{projectId}/finance_data_syncs/{financeDataSyncId}
       * @allow (create) Signed-in user can create a finance data sync within a project.
       * @deny (create) Non-signed-in user cannot create a finance data sync.
       * @allow (list) Signed-in user can list finance data syncs within a project.
       * @deny (update) Any user cannot update a finance data sync.
       * @deny (delete) Any user cannot delete a finance data sync.
       * @principle Enforces signed-in user for create and list operations on the /projects/{projectId}/finance_data_syncs collection.
       */
      match /finance_data_syncs/{financeDataSyncId} {
        allow get: if false;
        allow list: if isSignedIn();
        allow create: if isSignedIn();
        allow update: if false;
        allow delete: if false;
      }
    }

     /**
      * @description Rule for the /business_units collection.
      * @path /business_units
      * @allow (list) Signed-in user can list business_units.
      * @deny (create) Non-signed-in user cannot create a business_unit.
      * @deny (update) Any user cannot update a business_unit.
      * @deny (delete) Any user cannot delete a business_unit.
      * @principle Enforces signed-in user for list operations on the /business_units collection.
      *          Missing or insufficient permissions error fix
      */
      match /business_units/{business_unitId} {
         allow get: if false;
         allow list: if isSignedIn();
         allow create: if isSignedIn();
         allow update: if false;
         allow delete: if false;
       }
  }
}