/**
 * @description This ruleset enforces a strict user-ownership model for user-specific data (dashboards and widgets)
 *              and allows open read access for business unit data.
 *
 * Data Structure:
 * - /business_units/{businessUnitId}: Stores public business unit data.
 * - /business_units/{businessUnitId}/metrics/{metricId}: Stores public metric data associated with business units.
 * - /users/{userId}/dashboards/{dashboardId}: Stores user-specific dashboard configurations.
 * - /users/{userId}/dashboards/{dashboardId}/widgets/{widgetId}: Stores widgets belonging to a dashboard, owned by the user.
 * - /business_units/{businessUnitId}/alerts/{alertId}: Stores alert configurations for a business unit.
 *
 * Key Security Decisions:
 * - Business unit and metric data are publicly readable, but writes are disallowed in this prototype phase.
 * - Dashboards and widgets are strictly user-owned, preventing cross-user access.
 * - Listing of dashboards and widgets is only allowed by the owner.
 *
 * Denormalization for Authorization:
 *   - If collaborative access to dashboards/widgets is needed, denormalize a 'members' map onto the document.
 *
 * Structural Segregation:
 *   - Private user data (dashboards, widgets) is segregated under the `/users/{userId}` collection.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isSignedIn() && resource.data.userId == request.auth.uid;
    }
    /**
     * @description Allows anyone to read business unit data, but restricts writes.
     * @path /business_units/{businessUnitId}
     * @allow (get, list): Any user can read business unit data.
     * @deny (create, update, delete): No one can modify business unit data in this prototype.
     * @principle Allows public read access to business unit information.
     */
    match /business_units/{businessUnitId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Allows anyone to read metric data, but restricts writes.
     * @path /business_units/{businessUnitId}/metrics/{metricId}
     * @allow (get, list): Any user can read metric data.
     * @deny (create, update, delete): No one can modify metric data in this prototype.
     * @principle Allows public read access to metric information.
     */
    match /business_units/{businessUnitId}/metrics/{metricId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages user-specific dashboard configurations.
     * @path /users/{userId}/dashboards/{dashboardId}
     * @allow (create): User 'AnHykOXVqVhKEUFb7V8VNeQquTf2' can create a dashboard if the userId matches their auth.uid.
     * @allow (get, list): User 'AnHykOXVqVhKEUFb7V8VNeQquTf2' can read and list their own dashboards.
     * @allow (update, delete): User 'AnHykOXVqVhKEUFb7V8VNeQquTf2' can update/delete their own dashboards.
     * @deny (create, update, delete): User 'DIFFERENT_UID' cannot create, update, or delete dashboards under 'AnHykOXVqVhKEUFb7V8VNeQquTf2'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/dashboards/{dashboardId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Manages widgets belonging to a dashboard, owned by the user.
     * @path /users/{userId}/dashboards/{dashboardId}/widgets/{widgetId}
     * @allow (create): User 'AnHykOXVqVhKEUFb7V8VNeQquTf2' can create a widget if the userId matches their auth.uid.
     * @allow (get, list): User 'AnHykOXVqVhKEUFb7V8VNeQquTf2' can read and list their own widgets.
     * @allow (update, delete): User 'AnHykOXVqVhKEUFb7V8VNeQquTf2' can update/delete their own widgets.
     * @deny (create, update, delete): User 'DIFFERENT_UID' cannot create, update, or delete widgets under 'AnHykOXVqVhKEUFb7V8VNeQquTf2'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId}/dashboards/{dashboardId}/widgets/{widgetId} {
      allow create: if isOwner(userId);
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Allows anyone to read alert data, but restricts writes.
     * @path /business_units/{businessUnitId}/alerts/{alertId}
     * @allow (get, list): Any user can read alert data.
     * @deny (create, update, delete): No one can modify alert data in this prototype.
     * @principle Allows public read access to alert information.
     */
    match /business_units/{businessUnitId}/alerts/{alertId} {
      allow get: if true;
      allow list: if true;
      allow create, update, delete: if false;
    }

        /**
     * @description The error reported in the user request mentions a missing permissions error on the `/employees` collection.
     *              This match block is added to resolve the error, but the intention of the data in that collection is unknown.
     *              To avoid accidentally opening up a security hole, the rules are set to explicitly deny all access.
     * @path /employees
     * @allow None: No access is granted.
     * @deny Any: All operations are denied.
     * @principle Default deny for an unknown collection to prevent unintended data access.
     */
    match /employees/{employeeId} {
      allow get, list, create, update, delete: if false;
    }
  }
}