rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Allows access to project documents for authenticated users.
     * @path /projects/{projectId}
     */
    match /projects/{projectId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Manages access to module documents within a project.
     * @path /projects/{projectId}/modules/{moduleId}
     */
    match /projects/{projectId}/modules/{moduleId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.projectId == projectId;
      allow update: if isSignedIn() && request.resource.data.projectId == resource.data.projectId;
      allow delete: if isSignedIn() && resource.data.projectId == resource.data.projectId;
    }

    /**
     * @description Manages access to Telegram bot documents within a project.
     * @path /projects/{projectId}/telegram_bots/{telegramBotId}
     */
    match /projects/{projectId}/telegram_bots/{telegramBotId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.projectId == projectId;
      allow update: if isSignedIn() && resource.data.projectId == resource.data.projectId;
      allow delete: if isSignedIn() && resource.data.projectId == resource.data.projectId;
    }

    /**
     * @description Manages access to finance data sync documents within a project.
     * @path /projects/{projectId}/finance_data_syncs/{financeDataSyncId}
     */
    match /projects/{projectId}/finance_data_syncs/{financeDataSyncId} {
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.projectId == projectId;
      allow update: if isSignedIn() && resource.data.projectId == resource.data.projectId;
      allow delete: if isSignedIn() && resource.data.projectId == resource.data.projectId;
    }

    /**
     * @description  Placeholder for the savings_accounts collection.  List access is currently denied.
     * @path /savings_accounts
     */
    match /savings_accounts {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }
  }
}