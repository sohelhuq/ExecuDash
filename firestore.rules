/**
 * @fileOverview Firestore Security Rules for Firestudio.
 *
 * Core Philosophy:
 * This ruleset enforces a project-based ownership model.  Each project acts as a security boundary. Resources are owned by a project.
 *
 * Data Structure:
 * The Firestore database is organized hierarchically with the following structure:
 * - /projects/{projectId}: Contains project metadata.
 * - /projects/{projectId}/modules/{moduleId}: Contains module-specific data for a project.
 * - /projects/{projectId}/telegram_bots/{telegramBotId}: Contains Telegram bot connection details for a project.
 * - /projects/{projectId}/finance_data_syncs/{financeDataSyncId}: Contains finance data sync configurations for a project.
 *
 * Key Security Decisions:
 * - Strict project ownership: All resources (modules, Telegram bots, finance data syncs) are tied to a project ID.
 * - Denormalization: The 'projectId' is denormalized into subcollections to enable efficient and independent authorization checks.
 * - No public listing: List operations are restricted to prevent unauthorized data discovery.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secures project documents.
     * @path /projects/{projectId}
     * @allow (create) - Allow user to create a project with a matching project ID.
     * @deny (create) - Deny user to create a project with a non-matching project ID.
     * @allow (get) - Allow any authenticated user to read a project.
     * @allow (list) - Allow any authenticated user to list projects.
     * @allow (update) - Only allow if the project exists.
     * @allow (delete) - Only allow if the project exists.
     * @deny (update, delete) - Prevent modification of the project ID.
     * @principle Enforces project-level access control.
     */
    match /projects/{projectId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.id == projectId;
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Secures module documents within a project.
     * @path /projects/{projectId}/modules/{moduleId}
     * @allow (create) - Allow user to create a module with a matching project ID.
     * @deny (create) - Deny user to create a module with a non-matching project ID.
     * @allow (get) - Allow any authenticated user to read a module within a project.
     * @allow (list) - Allow any authenticated user to list modules within a project.
     * @allow (update) - Only allow if the module exists.
     * @allow (delete) - Only allow if the module exists.
     * @deny (update, delete) - Prevent modification of the project ID.
     * @principle Enforces project-scoped module access control.
     */
    match /projects/{projectId}/modules/{moduleId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.projectId == projectId;
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Secures Telegram bot connection details within a project.
     * @path /projects/{projectId}/telegram_bots/{telegramBotId}
     * @allow (create) - Allow user to create a telegram bot with a matching project ID.
     * @deny (create) - Deny user to create a telegram bot with a non-matching project ID.
     * @allow (get) - Allow any authenticated user to read a telegram bot configuration within a project.
     * @allow (list) - Allow any authenticated user to list telegram bots within a project.
     * @allow (update) - Only allow if the telegram bot exists.
     * @allow (delete) - Only allow if the telegram bot exists.
     * @deny (update, delete) - Prevent modification of the project ID.
     * @principle Enforces project-scoped Telegram bot access control.
     */
    match /projects/{projectId}/telegram_bots/{telegramBotId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.projectId == projectId;
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }

    /**
     * @description Secures finance data sync configurations within a project.
     * @path /projects/{projectId}/finance_data_syncs/{financeDataSyncId}
     * @allow (create) - Allow user to create a finance data sync with a matching project ID.
     * @deny (create) - Deny user to create a finance data sync with a non-matching project ID.
     * @allow (get) - Allow any authenticated user to read a finance data sync configuration within a project.
     * @allow (list) - Allow any authenticated user to list finance data sync configurations within a project.
     * @allow (update) - Only allow if the finance data sync exists.
     * @allow (delete) - Only allow if the finance data sync exists.
     * @deny (update, delete) - Prevent modification of the project ID.
     * @principle Enforces project-scoped finance data sync access control.
     */
    match /projects/{projectId}/finance_data_syncs/{financeDataSyncId} {
      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.projectId == projectId;
      allow update: if isSignedIn() && resource != null;
      allow delete: if isSignedIn() && resource != null;
    }
  }

  // Helper function to determine if the user is signed in
  function isSignedIn() {
    return request.auth != null;
  }
}