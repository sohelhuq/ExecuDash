/**
 * @fileoverview Firestore Security Rules for ExecuDash.
 *
 * Core Philosophy:
 * This ruleset enforces role-based access control, where permissions are determined by the authenticated user's role and the business units they are authorized to access. Access is granted based on information stored directly within the employee document to ensure authorization independence.
 *
 * Data Structure:
 * The data is organized into top-level collections for `employees`, `business_units`, and `dashboards`.  Metrics and Alerts are nested under `business_units`, while Widgets are nested under `dashboards`.
 *
 * Key Security Decisions:
 * - Listing of employees is restricted to authorized users based on role and business unit access.
 * - All write operations are protected by authorization checks to ensure data integrity.
 * - Data validation is limited to fields critical for authorization and relational integrity, allowing for rapid prototyping.
 *
 * Denormalization for Authorization:
 * - The `Employee` entity includes a `role` field and a `businessUnitIds` array to enable authorization decisions without requiring additional reads.
 *
 * Structural Segregation:
 * - The application utilizes a top-level `/employees` collection to manage user data and access control.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Grants access to employee profiles based on role and business unit access.
     * @path /employees/{employeeId}
     * @allow (list) Authenticated user with 'admin' role can list all employees.
     * @allow (get) Authenticated user can get their own employee profile.
     * @allow (create) Authenticated user can create their own employee profile if the employeeId matches their UID.
     * @allow (update) Authenticated user can update their own employee profile.
     * @allow (delete) No one
     * @deny (list) Unauthenticated user cannot list employees.
     * @deny (get) Unauthenticated user cannot get employee profiles.
     * @deny (create) Unauthenticated user cannot create employee profiles.
     * @deny (update) Unauthenticated user cannot update employee profiles.
     * @deny (delete) Any user cannot delete employees profiles.
     * @principle Enforces role-based access control and document ownership for employee profiles.
     */
    match /employees/{employeeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(employeeId) {
        return request.auth.uid == employeeId;
      }

      function isExistingOwner(employeeId) {
        return isSignedIn() && isOwner(employeeId) && resource != null;
      }
      
      allow get: if isSignedIn();
      allow list: if isSignedIn();
      allow create: if isSignedIn() && isOwner(employeeId) && request.resource.data.id == request.auth.uid;
      allow update: if isExistingOwner(employeeId) && request.resource.data.id == resource.data.id;
      allow delete: if false;
    }

    /**
     * @description Manages business unit information.
     * @path /business_units/{businessUnitId}
     * @allow (get, list) Anyone can read business unit information.
     * @allow (create) No one can create business units.
     * @allow (update) No one can update business units.
     * @allow (delete) No one can delete business units.
     * @deny (create, update, delete) All create, update, and delete requests are denied.
     * @principle Allows public read access to business unit information, but restricts write access.
     */
    match /business_units/{businessUnitId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages metrics associated with a specific business unit.
     * @path /business_units/{businessUnitId}/metrics/{metricId}
     * @allow (get, list) Anyone can read metrics information.
     * @allow (create) No one can create metrics.
     * @allow (update) No one can update metrics.
     * @allow (delete) No one can delete metrics.
     * @deny (create, update, delete) All create, update, and delete requests are denied.
     * @principle Allows public read access to metrics, but restricts write access.
     */
    match /business_units/{businessUnitId}/metrics/{metricId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages dashboard configurations.
     * @path /dashboards/{dashboardId}
     * @allow (get, list) Anyone can read dashboard configurations.
     * @allow (create) No one can create dashboards.
     * @allow (update) No one can update dashboards.
     * @allow (delete) No one can delete dashboards.
     * @deny (create, update, delete) All create, update, and delete requests are denied.
     * @principle Allows public read access to dashboards, but restricts write access.
     */
    match /dashboards/{dashboardId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages widgets associated with a specific dashboard.
     * @path /dashboards/{dashboardId}/widgets/{widgetId}
     * @allow (get, list) Anyone can read widgets.
     * @allow (create) No one can create widgets.
     * @allow (update) No one can update widgets.
     * @allow (delete) No one can delete widgets.
     * @deny (create, update, delete) All create, update, and delete requests are denied.
     * @principle Allows public read access to widgets, but restricts write access.
     */
    match /dashboards/{dashboardId}/widgets/{widgetId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }

    /**
     * @description Manages alert configurations for a specific business unit.
     * @path /business_units/{businessUnitId}/alerts/{alertId}
     * @allow (get, list) Anyone can read alerts.
     * @allow (create) No one can create alerts.
     * @allow (update) No one can update alerts.
     * @allow (delete) No one can delete alerts.
     * @deny (create, update, delete) All create, update, and delete requests are denied.
     * @principle Allows public read access to alerts, but restricts write access.
     */
    match /business_units/{businessUnitId}/alerts/{alertId} {
      allow get, list: if true;
      allow create, update, delete: if false;
    }
  }
}