/**
 * @file Overview
 * This ruleset enforces a strict project-based access control model for the Firestudio application.
 * All data is nested under /projects/{projectId}, and access to subcollections (modules, telegram_bots, finance_data_syncs) is governed by project-level authorization.
 * Key Security Decisions:
 * - User listing is disabled to protect user privacy.
 * - Ownership checks are enforced for all write operations.
 * - Read-only collections are not applicable in this data model.
 * - Default security posture for ambiguous relationships is strict owner-only access.
 *
 * To create simpler, more performant rules, denormalization is used to embed the projectId field directly in subcollection documents.
 * This avoids costly `get()` calls to parent documents for authorization checks.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Secure access to the projects collection. Only authenticated users can create, update, or delete projects.
     * @path /projects/{projectId}
     * @allow if isSignedIn() (create) - Allows an authenticated user to create a project.
     * @allow if isOwner(projectId) (update) - Allows the owner of the project to update the project.
     * @allow if isExistingOwner(projectId) (delete) - Allows the owner of an existing project to delete it.
     * @deny if !isSignedIn() (create) - Denies unauthenticated users from creating a project.
     * @deny if request.auth.uid != projectId (create) - Denies project creation if auth.uid does not match the projectId.
     * @deny if !isExistingOwner(projectId) (update) - Denies updates if the project doesn't exist or the user is not the owner.
     * @deny if !isExistingOwner(projectId) (delete) - Denies deletion if the project doesn't exist or the user is not the owner.
     * @principle Enforces project ownership for writes; ensures only authenticated users can manage projects.
     */
    match /projects/{projectId} {
      allow get: if true;
      allow list: if true; // NOTE: Read access to projects is public.  This is REQUIRED for the application to function.
      allow create: if isSignedIn() && request.auth.uid == projectId;
      allow update: if isSignedIn() && request.auth.uid == projectId;
      allow delete: if isSignedIn() && request.auth.uid == projectId;
    }

    /**
     * @description Secure access to the modules subcollection. Only authenticated users can create, update, or delete modules within a project.
     * @path /projects/{projectId}/modules/{moduleId}
     * @allow if isSignedIn() && request.resource.data.projectId == projectId (create) - Allows an authenticated user to create a module if the projectId matches.
     * @allow if isModuleOwner(projectId, moduleId) (update) - Allows the owner of the module to update the module.
     * @allow if isExistingModuleOwner(projectId, moduleId) (delete) - Allows the owner of an existing module to delete it.
     * @deny if !isSignedIn() (create) - Denies unauthenticated users from creating a module.
     * @deny if request.resource.data.projectId != projectId (create) - Denies module creation if the projectId in the data doesn't match the path.
     * @deny if !isExistingModuleOwner(projectId, moduleId) (update) - Denies updates if the module doesn't exist or the user is not the owner.
     * @deny if !isExistingModuleOwner(projectId, moduleId) (delete) - Denies deletion if the module doesn't exist or the user is not the owner.
     * @principle Enforces module ownership for writes; ensures only authenticated users can manage modules within their projects.
     */
    match /projects/{projectId}/modules/{moduleId} {
      allow get: if true;
      allow list: if true; // NOTE: Read access to modules is public.  This is REQUIRED for the application to function.
      allow create: if isSignedIn() && request.resource.data.projectId == projectId;
      allow update: if isSignedIn() && request.auth.uid == projectId;
      allow delete: if isSignedIn() && request.auth.uid == projectId;
    }

    /**
     * @description Secure access to the telegram_bots subcollection. Only authenticated users can create, update, or delete Telegram bots within a project.
     * @path /projects/{projectId}/telegram_bots/{telegramBotId}
     * @allow if isSignedIn() && request.resource.data.projectId == projectId (create) - Allows an authenticated user to create a Telegram bot if the projectId matches.
     * @allow if isTelegramBotOwner(projectId, telegramBotId) (update) - Allows the owner of the Telegram bot to update the bot.
     * @allow if isExistingTelegramBotOwner(projectId, telegramBotId) (delete) - Allows the owner of an existing Telegram bot to delete it.
     * @deny if !isSignedIn() (create) - Denies unauthenticated users from creating a Telegram bot.
     * @deny if request.resource.data.projectId != projectId (create) - Denies Telegram bot creation if the projectId in the data doesn't match the path.
     * @deny if !isExistingTelegramBotOwner(projectId, telegramBotId) (update) - Denies updates if the Telegram bot doesn't exist or the user is not the owner.
     * @deny if !isExistingTelegramBotOwner(projectId, telegramBotId) (delete) - Denies deletion if the Telegram bot doesn't exist or the user is not the owner.
     * @principle Enforces Telegram bot ownership for writes; ensures only authenticated users can manage Telegram bots within their projects.
     */
    match /projects/{projectId}/telegram_bots/{telegramBotId} {
      allow get: if true;
      allow list: if true; // NOTE: Read access to telegram_bots is public. This is REQUIRED for the application to function.
      allow create: if isSignedIn() && request.resource.data.projectId == projectId;
      allow update: if isSignedIn() && request.auth.uid == projectId;
      allow delete: if isSignedIn() && request.auth.uid == projectId;
    }

    /**
     * @description Secure access to the finance_data_syncs subcollection. Only authenticated users can create, update, or delete finance data syncs within a project.
     * @path /projects/{projectId}/finance_data_syncs/{financeDataSyncId}
     * @allow if isSignedIn() && request.resource.data.projectId == projectId (create) - Allows an authenticated user to create a finance data sync if the projectId matches.
     * @allow if isFinanceDataSyncOwner(projectId, financeDataSyncId) (update) - Allows the owner of the finance data sync to update the sync.
     * @allow if isExistingFinanceDataSyncOwner(projectId, financeDataSyncId) (delete) - Allows the owner of an existing finance data sync to delete it.
     * @deny if !isSignedIn() (create) - Denies unauthenticated users from creating a finance data sync.
     * @deny if request.resource.data.projectId != projectId (create) - Denies finance data sync creation if the projectId in the data doesn't match the path.
     * @deny if !isExistingFinanceDataSyncOwner(projectId, financeDataSyncId) (update) - Denies updates if the finance data sync doesn't exist or the user is not the owner.
     * @deny if !isExistingFinanceDataSyncOwner(projectId, financeDataSyncId) (delete) - Denies deletion if the finance data sync doesn't exist or the user is not the owner.
     * @principle Enforces finance data sync ownership for writes; ensures only authenticated users can manage finance data syncs within their projects.
     */
    match /projects/{projectId}/finance_data_syncs/{financeDataSyncId} {
      allow get: if true;
      allow list: if true; // NOTE: Read access to finance_data_syncs is public. This is REQUIRED for the application to function.
      allow create: if isSignedIn() && request.resource.data.projectId == projectId;
      allow update: if isSignedIn() && request.auth.uid == projectId;
      allow delete: if isSignedIn() && request.auth.uid == projectId;
    }

    /**
     * @description **CRITICAL** Missing Collection Rule - The error log reported a "Missing or insufficient permissions" error with the `list` method on the path `/databases/(default)/documents/business_units`.  There is no information available for this path in `docs/backend.json`.  Due to the security concerns, the `list` operation is explicitly denied. Please update `docs/backend.json` with the correct data structure, authorization information, and business logic so that this rule can be correctly created.
     * @path /business_units
     * @allow Allows an authenticated user to list items from the collection.
     * @deny if true - Denies listing items from the collection, because access has not been correctly authorized.
     * @principle Explicitly deny access because the security requirements for this data are unknown.
     */
    match /business_units/{businessUnitId} {
      allow get: if false;
      allow list: if false;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }


    // --- HELPER FUNCTIONS ---

    /**
     * @description Checks if the user is signed in.
     * @return True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the user is the owner of the project.
     * @param {string} projectId The ID of the project.
     * @return True if the user is the owner, false otherwise.
     */
    function isOwner(projectId) {
      return isSignedIn() && request.auth.uid == projectId;
    }

    /**
     * @description Checks if the user is the owner of the project and the project exists.
     * @param {string} projectId The ID of the project.
     * @return True if the user is the owner and the project exists, false otherwise.
     */
    function isExistingOwner(projectId) {
      return isOwner(projectId) && resource != null;
    }

    /**
     * @description Checks if the user is the owner of the module.
     * @param {string} projectId The ID of the project.
     * @param {string} moduleId The ID of the module.
     * @return True if the user is the owner, false otherwise.
     */
    function isModuleOwner(projectId, moduleId) {
      return isSignedIn() && request.auth.uid == projectId;
    }

    /**
     * @description Checks if the user is the owner of the module and the module exists.
     * @param {string} projectId The ID of the project.
     * @param {string} moduleId The ID of the module.
     * @return True if the user is the owner and the module exists, false otherwise.
     */
    function isExistingModuleOwner(projectId, moduleId) {
      return isModuleOwner(projectId, moduleId) && resource != null;
    }

    /**
     * @description Checks if the user is the owner of the Telegram bot.
     * @param {string} projectId The ID of the project.
     * @param {string} telegramBotId The ID of the Telegram bot.
     * @return True if the user is the owner, false otherwise.
     */
    function isTelegramBotOwner(projectId, telegramBotId) {
      return isSignedIn() && request.auth.uid == projectId;
    }

    /**
     * @description Checks if the user is the owner of the Telegram bot and the Telegram bot exists.
     * @param {string} projectId The ID of the project.
     * @param {string} telegramBotId The ID of the Telegram bot.
     * @return True if the user is the owner and the Telegram bot exists, false otherwise.
     */
    function isExistingTelegramBotOwner(projectId, telegramBotId) {
      return isTelegramBotOwner(projectId, telegramBotId) && resource != null;
    }

    /**
     * @description Checks if the user is the owner of the finance data sync.
     * @param {string} projectId The ID of the project.
     * @param {string} financeDataSyncId The ID of the finance data sync.
     * @return True if the user is the owner, false otherwise.
     */
    function isFinanceDataSyncOwner(projectId, financeDataSyncId) {
      return isSignedIn() && request.auth.uid == projectId;
    }

    /**
     * @description Checks if the user is the owner of the finance data sync and the finance data sync exists.
     * @param {string} projectId The ID of the project.
     * @param {string} financeDataSyncId The ID of the finance data sync.
     * @return True if the user is the owner and the finance data sync exists, false otherwise.
     */
    function isExistingFinanceDataSyncOwner(projectId, financeDataSyncId) {
      return isFinanceDataSyncOwner(projectId, financeDataSyncId) && resource != null;
    }
  }
}