/**
 * @fileoverview Firestore Security Rules for ExecuDash.
 *
 * Core Philosophy:
 * This ruleset implements role-based access control (RBAC) based on the 'Employee' entity's 'role' field.
 * It emphasizes authorization independence by denormalizing authorization data (roles, business unit access)
 * directly onto the 'Employee' documents themselves, avoiding costly `get()` calls.
 *
 * Data Structure:
 * - /employees/{employeeId}: Stores employee profiles with roles and accessible business units.
 * - /business_units/{businessUnitId}: Stores business unit information.
 * - /business_units/{businessUnitId}/metrics/{metricId}: Stores metrics for business units.
 * - /dashboards/{dashboardId}: Stores dashboard configurations.
 * - /dashboards/{dashboardId}/widgets/{widgetId}: Stores widgets for dashboards.
 * - /business_units/{businessUnitId}/alerts/{alertId}: Stores alerts for business units.
 *
 * Key Security Decisions:
 * - Only authenticated users can access data.
 * - Listing employees is restricted based on role and business unit access.
 * - Write permissions are restricted to ensure data integrity and prevent unauthorized modifications.
 * - Read-only access is granted to collections where all documents are considered public.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Manages employee profiles with role-based access control.
     * @path /employees/{employeeId}
     * @allow (create) - Authenticated user can create their own profile if the employeeId matches their UID.
     * @allow (get, list) - Authenticated user with 'admin' role can read any employee profile. Other users can only read their own profile.
     * @allow (update, delete) - Authenticated user with 'admin' role can update/delete any employee profile. Other users can only update/delete their own profile.
     * @deny (create) - If the employeeId does not match the authenticated user's UID.
     * @deny (get, list) - If a non-admin user attempts to read a different employee profile.
     * @deny (update, delete) - If a non-admin user attempts to update/delete a different employee profile.
     * @principle Enforces role-based access control and document ownership.
     */
    match /employees/{employeeId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isOwner(userId) {
        return isSignedIn() && request.auth.uid == userId;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.role == 'admin';
      }

      function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
      }

      // Read Permissions
      allow get: if isSignedIn() && (isOwner(employeeId) || isAdmin());
      allow list: if isSignedIn() && isAdmin();

      // Write Permissions
      allow create: if isOwner(employeeId) && request.resource.data.id == request.auth.uid;
      allow update: if isExistingOwner(employeeId) || isAdmin();
      allow delete: if isExistingOwner(employeeId) || isAdmin();
    }

    /**
     * @description Manages business unit information.
     * @path /business_units/{businessUnitId}
     * @allow (get, list) - Any authenticated user can read business unit information.
     * @allow (create) - Only admin users can create business units.
     * @allow (update, delete) - Only admin users can update or delete business units.
     * @deny (create) - If a non-admin user attempts to create a business unit.
     * @deny (update, delete) - If a non-admin user attempts to update/delete a business unit.
     * @principle Enforces role-based access control for creating, updating, and deleting business units.
     */
    match /business_units/{businessUnitId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.role == 'admin';
      }

      // Read Permissions
      allow get, list: if isSignedIn();

      // Write Permissions
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin() && resource != null;
      allow delete: if isSignedIn() && isAdmin() && resource != null;
    }

    /**
     * @description Manages metrics associated with a specific business unit.
     * @path /business_units/{businessUnitId}/metrics/{metricId}
     * @allow (get, list) - Any authenticated user can read metrics.
     * @allow (create) - Only admin users can create metrics.
     * @allow (update, delete) - Only admin users can update or delete metrics.
     * @deny (create) - If a non-admin user attempts to create a metric.
     * @deny (update, delete) - If a non-admin user attempts to update/delete a metric.
     * @principle Enforces role-based access control for managing metrics.
     */
    match /business_units/{businessUnitId}/metrics/{metricId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.role == 'admin';
      }

      // Read Permissions
      allow get, list: if isSignedIn();

      // Write Permissions
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin() && resource != null;
      allow delete: if isSignedIn() && isAdmin() && resource != null;
    }

    /**
     * @description Manages dashboard configurations.
     * @path /dashboards/{dashboardId}
     * @allow (get, list) - Any authenticated user can read dashboard configurations.
     * @allow (create) - Only admin users can create dashboards.
     * @allow (update, delete) - Only admin users can update or delete dashboards.
     * @deny (create) - If a non-admin user attempts to create a dashboard.
     * @deny (update, delete) - If a non-admin user attempts to update/delete a dashboard.
     * @principle Enforces role-based access control for managing dashboards.
     */
    match /dashboards/{dashboardId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.role == 'admin';
      }

      // Read Permissions
      allow get, list: if isSignedIn();

      // Write Permissions
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin() && resource != null;
      allow delete: if isSignedIn() && isAdmin() && resource != null;
    }

    /**
     * @description Manages widgets associated with a specific dashboard.
     * @path /dashboards/{dashboardId}/widgets/{widgetId}
     * @allow (get, list) - Any authenticated user can read widgets.
     * @allow (create) - Only admin users can create widgets.
     * @allow (update, delete) - Only admin users can update or delete widgets.
     * @deny (create) - If a non-admin user attempts to create a widget.
     * @deny (update, delete) - If a non-admin user attempts to update/delete a widget.
     * @principle Enforces role-based access control for managing widgets.
     */
    match /dashboards/{dashboardId}/widgets/{widgetId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.role == 'admin';
      }

      // Read Permissions
      allow get, list: if isSignedIn();

      // Write Permissions
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin() && resource != null;
      allow delete: if isSignedIn() && isAdmin() && resource != null;
    }

    /**
     * @description Manages alert configurations for a specific business unit.
     * @path /business_units/{businessUnitId}/alerts/{alertId}
     * @allow (get, list) - Any authenticated user can read alerts.
     * @allow (create) - Only admin users can create alerts.
     * @allow (update, delete) - Only admin users can update or delete alerts.
     * @deny (create) - If a non-admin user attempts to create an alert.
     * @deny (update, delete) - If a non-admin user attempts to update/delete an alert.
     * @principle Enforces role-based access control for managing alerts.
     */
    match /business_units/{businessUnitId}/alerts/{alertId} {
      function isSignedIn() {
        return request.auth != null;
      }

      function isAdmin() {
        return isSignedIn() && get(/databases/$(database)/documents/employees/$(request.auth.uid)).data.role == 'admin';
      }

      // Read Permissions
      allow get, list: if isSignedIn();

      // Write Permissions
      allow create: if isSignedIn() && isAdmin();
      allow update: if isSignedIn() && isAdmin() && resource != null;
      allow delete: if isSignedIn() && isAdmin() && resource != null;
    }
  }
}