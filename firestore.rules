/**
 * @fileoverview Firestore Security Rules for ExecuDash.
 *
 * Core Philosophy:
 * This ruleset enforces a strict user-ownership model for user-specific data
 * (dashboards).  Business unit data and its subcollections (metrics, widgets,
 * alerts) are currently open for all authenticated users, but this should be
 * reviewed and updated for production to enforce appropriate access controls.
 *
 * Data Structure:
 * - /users/{userId}: Stores user profiles.
 * - /users/{userId}/dashboards/{dashboardId}: Stores dashboards owned by a user.
 * - /business_units/{businessUnitId}: Stores information about business units.
 * - /business_units/{businessUnitId}/metrics/{metricId}: Stores metrics related to a specific business unit.
 * - /business_units/{businessUnitId}/widgets/{widgetId}: Stores widgets related to a specific business unit.
 * - /business_units/{businessUnitId}/alerts/{alertId}: Stores alert rules for a specific business unit.
 *
 * Key Security Decisions:
 * - User listing is disallowed.
 * - Business unit data is currently accessible to any signed-in user. This should
 *   be restricted to authorized users/roles in a production environment.
 * - Data shape is not strictly validated in this prototyping phase. Only
 *   authorization-critical fields are checked.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Protects the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) - Authenticated user can create their own user document.
     * @allow (get, list, update, delete) - Authenticated user can only access their own user document.
     * @deny (create) - If the authenticated user ID does not match the userId in the path.
     * @deny (get, list, update, delete) - If the authenticated user ID does not match the userId in the path.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      function isOwner(userId) {
        return request.auth != null && request.auth.uid == userId;
      }
      function isSignedIn() {
          return request.auth != null;
      }

      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow update: if isOwner(userId);
      allow delete: if isOwner(userId);
    }

    /**
     * @description Protects the /users/{userId}/dashboards/{dashboardId} collection.
     * @path /users/{userId}/dashboards/{dashboardId}
     * @allow (create, get, list, update, delete) - Authenticated user can only access their own dashboards.
     * @deny (create, get, list, update, delete) - If the authenticated user ID does not match the userId in the path.
     * @principle Enforces document ownership for dashboards.
     */
    match /users/{userId}/dashboards/{dashboardId} {
        function isOwner(userId) {
          return request.auth != null && request.auth.uid == userId;
        }

        allow get: if isOwner(userId);
        allow list: if isOwner(userId);
        allow create: if isOwner(userId);
        allow update: if isOwner(userId);
        allow delete: if isOwner(userId);
    }

    /**
     * @description Protects the /business_units/{businessUnitId} collection.
     * @path /business_units/{businessUnitId}
     * @allow (get, list) - Anyone can read business unit data.
     * @allow (create, update, delete) - Only authenticated users can modify business unit data.
     * @deny (create, update, delete) - if not authenticated.
     */
    match /business_units/{businessUnitId} {
      function isSignedIn() {
          return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add more granular role-based access control.
      allow update: if isSignedIn(); // TODO: Add more granular role-based access control.
      allow delete: if isSignedIn(); // TODO: Add more granular role-based access control.
    }

    /**
     * @description Protects the /business_units/{businessUnitId}/metrics/{metricId} collection.
     * @path /business_units/{businessUnitId}/metrics/{metricId}
     * @allow (get, list) - Anyone can read metric data.
     * @allow (create, update, delete) - Only authenticated users can modify metric data.
     * @deny (create, update, delete) - if not authenticated.
     */
    match /business_units/{businessUnitId}/metrics/{metricId} {
      function isSignedIn() {
          return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add more granular role-based access control.
      allow update: if isSignedIn(); // TODO: Add more granular role-based access control.
      allow delete: if isSignedIn(); // TODO: Add more granular role-based access control.
    }

   /**
     * @description Protects the /business_units/{businessUnitId}/widgets/{widgetId} collection.
     * @path /business_units/{businessUnitId}/widgets/{widgetId}
     * @allow (get, list) - Anyone can read widget data.
     * @allow (create, update, delete) - Only authenticated users can modify widget data.
     * @deny (create, update, delete) - if not authenticated.
     */
    match /business_units/{businessUnitId}/widgets/{widgetId} {
      function isSignedIn() {
          return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add more granular role-based access control.
      allow update: if isSignedIn(); // TODO: Add more granular role-based access control.
      allow delete: if isSignedIn(); // TODO: Add more granular role-based access control.
    }

    /**
     * @description Protects the /business_units/{businessUnitId}/alerts/{alertId} collection.
     * @path /business_units/{businessUnitId}/alerts/{alertId}
     * @allow (get, list) - Anyone can read alert data.
     * @allow (create, update, delete) - Only authenticated users can modify alert data.
     * @deny (create, update, delete) - if not authenticated.
     */
    match /business_units/{businessUnitId}/alerts/{alertId} {
      function isSignedIn() {
          return request.auth != null;
      }

      allow get, list: if true;
      allow create: if isSignedIn(); // TODO: Add more granular role-based access control.
      allow update: if isSignedIn(); // TODO: Add more granular role-based access control.
      allow delete: if isSignedIn(); // TODO: Add more granular role-based access control.
    }
  }
}