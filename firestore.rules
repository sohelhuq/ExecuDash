rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to project documents.
     * @path /projects/{projectId}
     * @allow get, list: if true;
     * @allow create: if false;
     * @allow update: if false;
     * @allow delete: if false;
     * @deny create: if false;
     * @deny update: if false;
     * @deny delete: if false;
     * @principle No authorization mechanism is explicitly defined for projects.
     * Assumes access is managed by an external system.
     */
    match /projects/{projectId} {
      allow get, list: if true;
      allow create: if false;
      allow update: if false;
      allow delete: if false;
    }

    /**
     * @description Controls access to module documents within a project.
     * @path /projects/{projectId}/modules/{moduleId}
     * @allow get: if isSignedIn() && isProjectMember(projectId);
     * @allow list: if isSignedIn() && isProjectMember(projectId);
     * @allow create: if isSignedIn() && isProjectOwner(projectId);
     * @allow update: if isSignedIn() && isProjectOwner(projectId);
     * @allow delete: if isSignedIn() && isProjectOwner(projectId);
     * @deny create: if !isSignedIn() || !isProjectOwner(projectId);
     * @deny update: if !isSignedIn() || !isProjectOwner(projectId) || resource == null;
     * @deny delete: if !isSignedIn() || !isProjectOwner(projectId) || resource == null;
     * @principle Enforces project membership for reads and project ownership for writes.
     */
    match /projects/{projectId}/modules/{moduleId} {
      allow get: if isSignedIn() && isProjectMember(projectId);
      allow list: if isSignedIn() && isProjectMember(projectId);
      allow create: if isSignedIn() && isProjectOwner(projectId);
      allow update: if isSignedIn() && isProjectOwner(projectId);
      allow delete: if isSignedIn() && isProjectOwner(projectId);
    }

    /**
     * @description Controls access to Telegram bot documents within a project.
     * @path /projects/{projectId}/telegram_bots/{telegramBotId}
     * @allow get: if isSignedIn() && isProjectMember(projectId);
     * @allow list: if isSignedIn() && isProjectMember(projectId);
     * @allow create: if isSignedIn() && isProjectOwner(projectId);
     * @allow update: if isSignedIn() && isProjectOwner(projectId);
     * @allow delete: if isSignedIn() && isProjectOwner(projectId);
     * @deny create: if !isSignedIn() || !isProjectOwner(projectId);
     * @deny update: if !isSignedIn() || !isProjectOwner(projectId) || resource == null;
     * @deny delete: if !isSignedIn() || !isProjectOwner(projectId) || resource == null;
     * @principle Enforces project membership for reads and project ownership for writes.
     */
    match /projects/{projectId}/telegram_bots/{telegramBotId} {
      allow get: if isSignedIn() && isProjectMember(projectId);
      allow list: if isSignedIn() && isProjectMember(projectId);
      allow create: if isSignedIn() && isProjectOwner(projectId);
      allow update: if isSignedIn() && isProjectOwner(projectId);
      allow delete: if isSignedIn() && isProjectOwner(projectId);
    }

    /**
     * @description Controls access to finance data sync documents within a project.
     * @path /projects/{projectId}/finance_data_syncs/{financeDataSyncId}
     * @allow get: if isSignedIn() && isProjectMember(projectId);
     * @allow list: if isSignedIn() && isProjectMember(projectId);
     * @allow create: if isSignedIn() && isProjectOwner(projectId);
     * @allow update: if isSignedIn() && isProjectOwner(projectId);
     * @allow delete: if isSignedIn() && isProjectOwner(projectId);
     * @deny create: if !isSignedIn() || !isProjectOwner(projectId);
     * @deny update: if !isSignedIn() || !isProjectOwner(projectId) || resource == null;
     * @deny delete: if !isSignedIn() || !isProjectOwner(projectId) || resource == null;
     * @principle Enforces project membership for reads and project ownership for writes.
     */
    match /projects/{projectId}/finance_data_syncs/{financeDataSyncId} {
      allow get: if isSignedIn() && isProjectMember(projectId);
      allow list: if isSignedIn() && isProjectMember(projectId);
      allow create: if isSignedIn() && isProjectOwner(projectId);
      allow update: if isSignedIn() && isProjectOwner(projectId);
      allow delete: if isSignedIn() && isProjectOwner(projectId);
    }

    function isSignedIn() {
      return request.auth != null;
    }

    function isProjectMember(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)).data.members[request.auth.uid] != null;
    }

    function isProjectOwner(projectId) {
      return get(/databases/$(database)/documents/projects/$(projectId)).data.members[request.auth.uid] == 'owner';
    }
  }
}