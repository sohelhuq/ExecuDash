{
  "entities": {
    "BusinessUnit": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "BusinessUnit",
      "type": "object",
      "description": "Represents a business unit within the Shetue Group.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the BusinessUnit entity."
        },
        "name": {
          "type": "string",
          "description": "The canonical name of the business unit (e.g., 'Setu Filling Station')."
        },
        "aliases": {
          "type": "array",
          "description": "Alternative names or abbreviations for the business unit (e.g., ['fuel station', 'the pump']).",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name"
      ]
    },
    "Metric": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Metric",
      "type": "object",
      "description": "Represents a measurable quantity or indicator for a specific business unit.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Metric entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the metric (e.g., 'daily_sales')."
        },
        "businessUnitId": {
          "type": "string",
          "description": "Reference to BusinessUnit. (Relationship: BusinessUnit 1:N Metric). Indicates which business unit this metric belongs to."
        },
        "description": {
          "type": "string",
          "description": "A description of what the metric is."
        }
      },
      "required": [
        "id",
        "name",
        "businessUnitId"
      ]
    },
    "Dashboard": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Dashboard",
      "type": "object",
      "description": "Represents a dashboard configuration, including the widgets and layout.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Dashboard entity."
        },
        "name": {
          "type": "string",
          "description": "The name of the dashboard."
        },
        "layout": {
          "type": "string",
          "description": "The layout configuration of the dashboard (e.g., JSON string)."
        },
        "description": {
          "type": "string",
          "description": "A description of the dashboard."
        }
      },
      "required": [
        "id",
        "name",
        "layout"
      ]
    },
    "Widget": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Widget",
      "type": "object",
      "description": "Represents a single widget on a dashboard, displaying a specific metric.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Widget entity."
        },
        "dashboardId": {
          "type": "string",
          "description": "Reference to Dashboard. (Relationship: Dashboard 1:N Widget). Indicates which dashboard this widget belongs to."
        },
        "metricId": {
          "type": "string",
          "description": "Reference to Metric. (Relationship: Metric 1:N Widget). The metric displayed by this widget."
        },
        "visualization": {
          "type": "string",
          "description": "The type of visualization used for the widget (e.g., 'line', 'bar')."
        },
        "position": {
          "type": "string",
          "description": "The position of the widget on the dashboard (e.g., JSON string with coordinates)."
        },
        "timeframe": {
          "type": "string",
          "description": "The default timeframe for this widget (e.g., 'past_30d')."
        }
      },
      "required": [
        "id",
        "dashboardId",
        "metricId",
        "visualization",
        "position"
      ]
    },
    "Alert": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Alert",
      "type": "object",
      "description": "Represents an alert rule that triggers when a specific condition is met.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Alert entity."
        },
        "businessUnitId": {
          "type": "string",
          "description": "Reference to BusinessUnit. (Relationship: BusinessUnit 1:N Alert). The business unit to monitor."
        },
        "metricId": {
          "type": "string",
          "description": "Reference to Metric. (Relationship: Metric 1:N Alert). The metric to monitor."
        },
        "conditionOperator": {
          "type": "string",
          "description": "The operator used in the alert condition (e.g., '<', '>')."
        },
        "conditionValue": {
          "type": "number",
          "description": "The value used in the alert condition."
        },
        "durationMinutes": {
          "type": "number",
          "description": "The duration (in minutes) for which the condition must be true before the alert is triggered."
        },
        "notifyChannels": {
          "type": "array",
          "description": "The channels to use for sending notifications (e.g., ['telegram', 'email']).",
          "items": {
            "type": "string"
          }
        },
        "severity": {
          "type": "string",
          "description": "The severity level of the alert (e.g., 'low', 'medium', 'high')."
        },
        "description": {
          "type": "string",
          "description": "A description of what the alert is monitoring."
        }
      },
      "required": [
        "id",
        "businessUnitId",
        "metricId",
        "conditionOperator",
        "conditionValue",
        "durationMinutes",
        "notifyChannels",
        "severity"
      ]
    },
    "Employee": {
      "$schema": "http://json-schema.org/draft-07/schema#",
      "title": "Employee",
      "type": "object",
      "description": "Represents an employee with access to the ExecuDash application.",
      "properties": {
        "id": {
          "type": "string",
          "description": "Unique identifier for the Employee entity."
        },
        "name": {
          "type": "string",
          "description": "The full name of the employee."
        },
        "email": {
          "type": "string",
          "description": "The email address of the employee.",
          "format": "email"
        },
        "role": {
          "type": "string",
          "description": "The role of the employee within the organization (e.g., 'admin', 'manager', 'analyst')."
        },
        "businessUnitIds": {
          "type": "array",
          "description": "References to BusinessUnits. (Relationship: Employee N:N BusinessUnit). The business units the employee has access to.",
          "items": {
            "type": "string"
          }
        }
      },
      "required": [
        "id",
        "name",
        "email",
        "role"
      ]
    }
  },
  "auth": {
    "providers": [
      "password",
      "anonymous"
    ]
  },
  "firestore": {
    "structure": [
      {
        "path": "/employees/{employeeId}",
        "definition": {
          "entityName": "Employee",
          "schema": {
            "$ref": "#/backend/entities/Employee"
          },
          "description": "Stores employee profiles, including their roles and accessible business units. This collection is central to role-based access control and business unit authorization. Includes denormalized 'role' and 'businessUnitIds' fields for authorization independence.",
          "params": [
            {
              "name": "employeeId",
              "description": "Unique identifier for the employee."
            }
          ]
        }
      },
      {
        "path": "/business_units/{businessUnitId}",
        "definition": {
          "entityName": "BusinessUnit",
          "schema": {
            "$ref": "#/backend/entities/BusinessUnit"
          },
          "description": "Stores business unit information.  No denormalized authorization fields required at this level.",
          "params": [
            {
              "name": "businessUnitId",
              "description": "Unique identifier for the business unit."
            }
          ]
        }
      },
      {
        "path": "/business_units/{businessUnitId}/metrics/{metricId}",
        "definition": {
          "entityName": "Metric",
          "schema": {
            "$ref": "#/backend/entities/Metric"
          },
          "description": "Stores metrics associated with a specific business unit. Inherits security context from the parent business_units collection.",
          "params": [
            {
              "name": "businessUnitId",
              "description": "Unique identifier for the business unit."
            },
            {
              "name": "metricId",
              "description": "Unique identifier for the metric."
            }
          ]
        }
      },
      {
        "path": "/dashboards/{dashboardId}",
        "definition": {
          "entityName": "Dashboard",
          "schema": {
            "$ref": "#/backend/entities/Dashboard"
          },
          "description": "Stores dashboard configurations.  No denormalized authorization fields required at this level.",
          "params": [
            {
              "name": "dashboardId",
              "description": "Unique identifier for the dashboard."
            }
          ]
        }
      },
      {
        "path": "/dashboards/{dashboardId}/widgets/{widgetId}",
        "definition": {
          "entityName": "Widget",
          "schema": {
            "$ref": "#/backend/entities/Widget"
          },
          "description": "Stores widgets associated with a specific dashboard. Inherits security context from the parent dashboards collection.",
          "params": [
            {
              "name": "dashboardId",
              "description": "Unique identifier for the dashboard."
            },
            {
              "name": "widgetId",
              "description": "Unique identifier for the widget."
            }
          ]
        }
      },
      {
        "path": "/business_units/{businessUnitId}/alerts/{alertId}",
        "definition": {
          "entityName": "Alert",
          "schema": {
            "$ref": "#/backend/entities/Alert"
          },
          "description": "Stores alert configurations for a specific business unit. Inherits security context from the parent business_units collection.",
          "params": [
            {
              "name": "businessUnitId",
              "description": "Unique identifier for the business unit."
            },
            {
              "name": "alertId",
              "description": "Unique identifier for the alert."
            }
          ]
        }
      }
    ],
    "reasoning": "The Firestore structure is designed to address the 'Missing or insufficient permissions' error by ensuring authorization independence and supporting secure list operations. The key is to use Structural Segregation (Homogeneous Security Posture) and Access Modeling (Standardization and Consistency) to make it work. The error indicates a 'list' operation on the 'employees' collection is failing because of permission issues. We need to grant appropriate permissions to list employees based on their role and business unit access.\n\n**Authorization Independence:** The structure will leverage roles stored in `/employees/{employeeId}` (DBAC: Database-Based Access Control), eliminating the need for `get()` calls to other documents for authorization. This ensures atomic operations and simplifies security rules.\n\n**QAPs (Rules are not Filters):**  The structure separates employee data into a top-level collection `/employees`, all documents in this collection share the same security requirements.\n\n**Employee Roles and Business Unit Access:** Employee documents contain an array of `businessUnitIds` they have access to. This is critical for implementing role-based and business-unit-based authorization. Each employee document contains all the information required to make authorization decisions without reading other documents.\n\n**Security Rules:** The security rules will use `request.auth.uid` to determine the requesting user and then check the user's role and `businessUnitIds` within the `/employees/{employeeId}` document. This allows secure listing of employees based on role and business unit access. This ensures only authorized users can access the employee data."
  }
}